
# azure-pipelines.yml
trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '20.x'

stages:
- stage: Build
  displayName: 'Build Stage'
  jobs:
  - job: Build
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '$(nodeVersion)'
    
    - script: |
        cd backend
        npm ci
      displayName: 'Install Backend'
    
    - script: |
        cd frontend
        npm ci
        npm run build
      displayName: 'Build Frontend'
    
    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: 'frontend/build'
        artifactName: 'frontend-build'

- stage: Deploy_Infrastructure
  displayName: 'Deploy Azure Infrastructure'
  dependsOn: Build
  jobs:
  - job: Deploy_ARM
    steps:
    - task: AzureResourceManagerTemplateDeployment@3
      inputs:
        deploymentScope: 'Resource Group'
        azureResourceManagerConnection: 'Your-Azure-Service-Connection-Name'
        action: 'Create Or Update Resource Group'
        resourceGroupName: 'ecommerce-dissertation-rg'
        location: 'East US'
        templateLocation: 'Linked artifact'
        csmFile: 'infrastructure/azure/azuredeploy.json'
        deploymentMode: 'Incremental'
